
@using HaemophilusWeb.Utils
@using Microsoft.Extensions.Logging
@using NRZMyk.Services.Data.Entities
@using NRZMyk.Services.Services
@using NRZMyk.Components.SharedComponents.Input
@using NRZMyk.Services.Models
@inherits CreateBase

<h2>Neu anlegen</h2>

<div>
    <EditForm Model="_item" OnValidSubmit="@CreateClick">

        <DataAnnotationsValidator />

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Material</label>
            <div class="col-sm-6">
                <InputSelect class="form-control" @bind-Value="_item.Material">
                    @foreach (var material in EnumUtils.AllEnumValues<Material>())
                    {
                        <option value="@material">@EnumUtils.GetEnumDescription(material)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.Material" />
            </div>
        </div>

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Alter des Patienten</label>
            <div class="col-sm-6">
                <InputSelect class="form-control" @bind-Value="_item.AgeGroup">
                    @foreach (var ageGroup in EnumUtils.AllEnumValues<AgeGroup>())
                    {
                        <option value="@ageGroup">@EnumUtils.GetEnumDescription(ageGroup)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.AgeGroup" />
            </div>
        </div>

        <div class="form-group row">
            <label class="control-label col-sm-4">Probentnahme</label>
            <div class="col-sm-6">
                <InputDate class="form-control" @bind-Value="_item.SamplingDate" />
                <ValidationMessage For="() => _item.SamplingDate" />
            </div>
        </div>

        <InputTextWithValidation FieldName="Labornummer Einsender" @bind-Value="_item.SenderLaboratoryNumber" For="() => _item.SenderLaboratoryNumber" />

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Station</label>
            <div class="col-sm-3">
                <InputSelect class="form-control" @bind-Value="_item.HospitalDepartmentType">
                    @foreach (var departmentType in EnumUtils.AllEnumValues<HospitalDepartmentType>())
                    {
                        <option value="@departmentType">@EnumUtils.GetEnumDescription(departmentType)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.HospitalDepartmentType" />
            </div>
            <div class="col-sm-3">
                <InputSelect class="form-control" @bind-Value="_item.HospitalDepartment">
                    @foreach (var department in EnumUtils.AllEnumValues<HospitalDepartment>())
                    {
                        <option value="@department">@EnumUtils.GetEnumDescription(department)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.HospitalDepartment" />
            </div>
        </div>

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Spezies</label>
            <div class="col-sm-6">
                <InputSelect class="form-control" @bind-Value="_item.IdentifiedSpecies">
                    @foreach (var species in EnumUtils.AllEnumValues<Species>())
                    {
                        <option value="@species">@EnumUtils.GetEnumDescription(species)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.IdentifiedSpecies" />
            </div>
        </div>

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Methode Speziesidentifikation</label>
            <div class="col-sm-6">
                <InputSelect class="form-control" @bind-Value="_item.SpeciesIdentificationMethod">
                    @foreach (var identificationMethod in EnumUtils.AllEnumValues<SpeciesIdentificationMethod>())
                    {
                        <option value="@identificationMethod">@EnumUtils.GetEnumDescription(identificationMethod)</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => _item.SpeciesIdentificationMethod" />
            </div>
        </div>

        <div class="form-group row">
            <label class="col-form-label col-sm-4">Anmerkungen</label>
            <div class="col-sm-6">
                <InputTextArea class="form-control" @bind-Value="_item.Remark" />
                <ValidationMessage For="() => _item.Remark" />
            </div>
        </div>

        <h3>Tests</h3>
        <div class="form-group row">
            <div class="col-sm-2">
                <select class="form-control" @bind="_testingMethod">
                    @foreach (var testingMethod in EnumUtils.AllEnumValues<SpeciesTestingMethod>().Where(t => t == SpeciesTestingMethod.Vitek))
                    {
                        <option value="@testingMethod">@EnumUtils.GetEnumDescription(testingMethod)</option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <select class="form-control" @bind="_antifungalAgent">
                    @foreach (var antifungalAgent in EnumUtils.AllEnumValues<AntifungalAgent>().Where(t =>

                        new List<AntifungalAgent> {AntifungalAgent.Micafungin, AntifungalAgent.Caspofungin, AntifungalAgent.Voriconazole, AntifungalAgent.Fluconazole, AntifungalAgent.AmphotericinB}.Contains(t)))
                    {
                        <option value="@antifungalAgent">@EnumUtils.GetEnumDescription(antifungalAgent)</option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-outline-secondary" @onclick="AddAntimicrobialSensitivityTest">Neuer MHK Eintrag</button>
            </div>
        </div>

        @foreach (var sensitivityTest in RecalculateResistance())
        {
            <div class="form-group row">
                <div class="col-sm-2">
                    <p class="form-control-plaintext">
                        <b>@sensitivityTest.TestingMethod</b> - @sensitivityTest.AntifungalAgent
                    </p>
                </div>

                <div class="col-sm-2">
                    <div class="input-group mb-2 mr-sm-2">
                        <div class="input-group-prepend">
                            <div class="input-group-text">MHK</div>
                        </div>
                        <InputSelect class="form-control" @bind-Value="sensitivityTest.MinimumInhibitoryConcentration">
                            <option value="0.06">≤0.06</option>
                            <option value="0.12">0.12</option>
                            <option value="0.25">0.25</option>
                            <option value="0.5">0.5</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="4">4</option>
                            <option value="8">≥8</option>
                        </InputSelect>
                    </div>

                </div>
                <div class="col-sm-4">
                    <InputSelectNumber class="form-control" @bind-Value="sensitivityTest.EucastClinicalBreakpointId">
                        @foreach (var breakpoint in _clinicalBreakpoints)
                            {
                            <option value="@breakpoint.Id">@breakpoint.Title</option>
                            }
                    </InputSelectNumber>
                </div>
                <div class="col-sm-4">
                    <p class="form-control-plaintext">
                        <span class="badge @(ResistenceBadge(sensitivityTest))">
                            @EnumUtils.GetEnumDescription(sensitivityTest.Resistance)
                        </span>
                    </p>
                </div>
            </div>
        }

        <div class="form-group row">
            <div class="offset-4 col-sm-6 text-right">
                <a href="" @onclick="() => OnCloseClick.InvokeAsync(null)" @onclick:preventDefault class="btn btn-secondary">
                    Abbrechen
                </a>
                <button type="submit" class="btn btn-primary">
                    Anlegen
                </button>
            </div>
        </div>
    </EditForm>
</div>